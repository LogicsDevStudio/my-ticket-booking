<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏ï‡∏±‡πã‡∏ß Real-time (Locking)</title>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; }
        .screen { background: #333; color: white; padding: 10px; margin-bottom: 20px; }
        .seat-container { display: grid; grid-template-columns: repeat(4, 50px); gap: 10px; justify-content: center; }
        
        .seat {
            width: 50px; height: 50px; background-color: #ddd; 
            border-radius: 5px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: black; font-weight: bold;
            transition: background-color 0.2s;
        }

        /* üü© ‡∏ß‡πà‡∏≤‡∏á */
        .seat.available { background-color: #28a745; color: white; }
        
        /* üü• ‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß */
        .seat.taken { background-color: #dc3545; color: white; cursor: not-allowed; }
        
        /* üüß ‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (‡∏´‡πâ‡∏≤‡∏°‡∏Å‡∏î) */
        .seat.holding-other { background-color: #fd7e14; color: white; cursor: not-allowed; opacity: 0.6; }

        /* üü¶ ‡πÄ‡∏£‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (‡∏Å‡∏î‡∏à‡∏≠‡∏á‡πÑ‡∏î‡πâ) */
        .seat.holding-me { background-color: #007bff; color: white; border: 3px solid #0056b3; }

        #bookingForm { margin-top: 20px; display: none; }
        .legend { margin-top: 20px; font-size: 0.8rem; }
        .dot { width: 10px; height: 10px; display: inline-block; margin-right: 5px; }
    </style>
</head>
<body>

    <h1>‡∏à‡∏≠‡∏á‡∏ï‡∏±‡πã‡∏ß‡∏´‡∏ô‡∏±‡∏á Real-time</h1>
    <div class="screen">‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏†‡∏≤‡∏û‡∏¢‡∏ô‡∏ï‡∏£‡πå</div>
    
    <div class="seat-container" id="seatMap"></div>

    <div class="legend">
        <span class="dot" style="background:#28a745"></span>‡∏ß‡πà‡∏≤‡∏á 
        <span class="dot" style="background:#007bff"></span>‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 
        <span class="dot" style="background:#fd7e14"></span>‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏¢‡∏π‡πà 
        <span class="dot" style="background:#dc3545"></span>‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß
    </div>

    <div id="bookingForm">
        <h3>‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: <span id="selectedSeatDisp"></span></h3>
        <input type="text" id="userName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì" required>
        <button onclick="confirmBooking()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</button>
        <button onclick="cancelSelection()" style="background:#999">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, set, remove, onDisconnect } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // --- 1. ‡πÉ‡∏™‡πà Config ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ---
        const firebaseConfig = {
        apiKey: "AIzaSyCVrVE7okZklN4vmb32RSzsC7JdV7YmcVs",
        authDomain: "oph-booking.firebaseapp.com",
        databaseURL: "https://oph-booking-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "oph-booking",
        storageBucket: "oph-booking.firebasestorage.app",
        messagingSenderId: "222932745199",
        appId: "1:222932745199:web:2f899a96964ab5a5f5141a"
        };

        // --- 2. ‡πÉ‡∏™‡πà URL Google Script ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ---
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxdHa_9aRkfX9N5lz_lQr-2xdjm8jyrWY6vmM63ixfw3JSws8w2J8UglEs-bGnuU5wHFw/exec";

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á ID ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏Ñ‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (Session ID) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡πÉ‡∏Ñ‡∏£‡πÄ‡∏õ‡πá‡∏ô‡πÉ‡∏Ñ‡∏£
        const mySessionId = 'user_' + Math.random().toString(36).substr(2, 9);
        console.log("My ID:", mySessionId);

        const seatsList = ['A1', 'A2', 'A3', 'A4', 'B1', 'B2', 'B3', 'B4'];
        const seatMap = document.getElementById('seatMap');
        let myCurrentSeat = null; // ‡πÄ‡∏Å‡πá‡∏ö‡∏ß‡πà‡∏≤‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÑ‡∏´‡∏ô‡∏≠‡∏¢‡∏π‡πà

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á
        seatsList.forEach(seatId => {
            const div = document.createElement('div');
            div.className = 'seat available';
            div.innerText = seatId;
            div.id = seatId;
            div.onclick = () => selectSeat(seatId);
            seatMap.appendChild(div);
        });

        // --- Realtime Listener: ‡∏ü‡∏±‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏≤‡∏Å Firebase ---
        const seatsRef = ref(db, 'seats');
        onValue(seatsRef, (snapshot) => {
            const data = snapshot.val() || {};
            
            seatsList.forEach(seatId => {
                const el = document.getElementById(seatId);
                const seatData = data[seatId];

                // Reset class ‡∏Å‡πà‡∏≠‡∏ô
                el.className = 'seat available';

                if (seatData) {
                    if (seatData.status === 'taken') {
                        // 1. ‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß -> ‡∏™‡∏µ‡πÅ‡∏î‡∏á
                        el.classList.add('taken');
                    } else if (seatData.status === 'holding') {
                        // 2. ‡∏°‡∏µ‡∏Ñ‡∏ô‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏¢‡∏π‡πà... ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏£‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô?
                        if (seatData.holder === mySessionId) {
                            el.classList.add('holding-me'); // ‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô (‡πÄ‡∏£‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)
                            myCurrentSeat = seatId;
                            showForm(seatId);
                        } else {
                            el.classList.add('holding-other'); // ‡∏™‡∏µ‡∏™‡πâ‡∏° (‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)
                        }
                    }
                }
            });
        });

        // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á ---
        window.selectSeat = (seatId) => {
            const el = document.getElementById(seatId);
            
            // ‡∏ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á (‡πÅ‡∏î‡∏á ‡∏´‡∏£‡∏∑‡∏≠ ‡∏™‡πâ‡∏°) ‡∏Å‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ
            if (el.classList.contains('taken') || el.classList.contains('holding-other')) {
                return;
            }

            // ‡∏ñ‡πâ‡∏≤‡∏Å‡∏î‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß -> ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
            if (seatId === myCurrentSeat) {
                cancelSelection();
                return;
            }

            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Ñ‡∏¢‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡∏≠‡∏∑‡πà‡∏ô‡∏≠‡∏¢‡∏π‡πà ‡πÉ‡∏´‡πâ‡∏õ‡∏•‡∏î‡∏ï‡∏±‡∏ß‡πÄ‡∏Å‡πà‡∏≤‡∏≠‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡∏•‡∏∞ 1 ‡∏ó‡∏µ‡πà)
            if (myCurrentSeat) {
                remove(ref(db, 'seats/' + myCurrentSeat));
            }

            // ‡∏à‡∏≠‡∏á‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡πÉ‡∏´‡∏°‡πà (‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏•‡∏á Firebase ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ)
            // ‡πÉ‡∏ä‡πâ onDisconnect().remove() ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏±‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏ô‡πá‡∏ï‡∏´‡∏•‡∏∏‡∏î/‡∏õ‡∏¥‡∏î‡∏à‡∏≠ ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∑‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            const seatRef = ref(db, 'seats/' + seatId);
            set(seatRef, {
                status: 'holding',
                holder: mySessionId,
                timestamp: Date.now()
            });
            onDisconnect(seatRef).remove(); // *‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç* ‡∏ñ‡πâ‡∏≤‡∏õ‡∏¥‡∏î‡∏à‡∏≠ ‡πÉ‡∏´‡πâ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• holding ‡∏≠‡∏≠‡∏Å
        };

        // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ---
        window.cancelSelection = () => {
            if (myCurrentSeat) {
                remove(ref(db, 'seats/' + myCurrentSeat)); // ‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å Firebase
                myCurrentSeat = null;
                document.getElementById('bookingForm').style.display = 'none';
            }
        };

        // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á ---
        window.confirmBooking = () => {
            const name = document.getElementById('userName').value;
            if (!name) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠");
            if (!myCurrentSeat) return;

            const seatToBook = myCurrentSeat; // ‡∏à‡∏≥‡∏Ñ‡πà‡∏≤‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô

            // 1. ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏ô Firebase ‡πÄ‡∏õ‡πá‡∏ô taken (‡∏ñ‡∏≤‡∏ß‡∏£)
            set(ref(db, 'seats/' + seatToBook), {
                status: 'taken',
                owner: name,
                timestamp: Date.now()
            });

            // 2. ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤ Google Sheets
            fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: name, seat: seatToBook })
            }).then(() => {
                alert("‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
                // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏° (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á reload ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏Å‡πá‡πÑ‡∏î‡πâ ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ Firebase ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß)
                document.getElementById('userName').value = '';
                document.getElementById('bookingForm').style.display = 'none';
                myCurrentSeat = null;
            }).catch(err => console.error(err));
        };

        function showForm(seatId) {
            document.getElementById('bookingForm').style.display = 'block';
            document.getElementById('selectedSeatDisp').innerText = seatId;
        }
    </script>
</body>
</html>
