<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏ï‡∏±‡πã‡∏ß Universal</title>
    <style>
        body { font-family: 'Sarabun', sans-serif; text-align: center; padding: 20px; background-color: #f8f9fa; }
        h1 { margin-bottom: 5px; }
        h3 { color: #666; margin-top: 0; }
        
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        
        /* UI ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏£‡∏á‡∏´‡∏ô‡∏±‡∏á */
        .screen { background: #333; color: white; padding: 5px; margin: 15px 0; border-radius: 5px; font-size: 0.8rem; }
        .seat-row { display: flex; justify-content: center; margin-bottom: 8px; gap: 8px; }
        .seat {
            width: 40px; height: 40px; background-color: #e2e6ea; 
            border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; 
            font-size: 0.8rem; font-weight: bold; color: #495057;
            transition: all 0.2s;
        }
        .seat.available:hover { transform: scale(1.1); background-color: #dbeecd; }
        
        /* ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏µ */
        .seat.available { background-color: #28a745; color: white; }
        .seat.taken { background-color: #dc3545; color: white; cursor: not-allowed; opacity: 0.5; }
        .seat.holding-other { background-color: #fd7e14; color: white; cursor: not-allowed; opacity: 0.7; }
        .seat.holding-me { background-color: #007bff; color: white; border: 2px solid #0056b3; box-shadow: 0 0 5px #007bff; }

        /* UI ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ */
        .general-box { padding: 40px; text-align: center; }
        .counter { font-size: 3rem; font-weight: bold; color: #333; }
        .limit-text { color: #666; font-size: 1rem; }
        
        /* ‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏•‡∏∞‡∏õ‡∏∏‡πà‡∏° */
        #bookingForm { margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; display: none; }
        input { padding: 10px; width: 70%; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 10px; }
        button { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 1rem; color: white; }
        .btn-confirm { background-color: #007bff; width: 100%; }
        .btn-cancel { background-color: #6c757d; margin-top: 10px; font-size: 0.9rem; background: none; color: #666; text-decoration: underline;}

        .hidden { display: none !important; }
        .loading { color: #666; margin-top: 20px; }
    </style>
</head>
<body>

    <div class="container">
        <div id="loading" class="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå...</div>
        
        <div id="content" class="hidden">
            <h1 id="eventName">‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå</h1>
            <h3 id="eventTypeDisplay">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</h3>

            <div id="cinemaZone" class="hidden">
                <div class="screen">‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏†‡∏≤‡∏û‡∏¢‡∏ô‡∏ï‡∏£‡πå</div>
                <div id="seatMap"></div>
                <div style="margin-top:10px; font-size:0.8rem; color:#666;">
                    üü¢ ‡∏ß‡πà‡∏≤‡∏á | üîµ ‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡∏∑‡∏≠‡∏Å | üü† ‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å | üî¥ ‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß
                </div>
            </div>

            <div id="generalZone" class="hidden">
                <div class="general-box">
                    <div class="limit-text">‡∏ö‡∏±‡∏ï‡∏£‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß</div>
                    <div id="counterDisplay" class="counter">0</div>
                    <div id="limitDisplay" class="limit-text">‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î - ‡πÉ‡∏ö</div>
                    <button id="generalBookBtn" class="btn-confirm" style="margin-top: 20px; background:#28a745;">‡∏à‡∏≠‡∏á‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏•‡∏¢</button>
                </div>
            </div>

            <div id="bookingForm">
                <p>‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏≠‡∏á: <strong><span id="selectedItemName"></span></strong></p>
                <input type="text" id="userName" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì" required>
                <button onclick="confirmBooking()" class="btn-confirm">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</button>
                <button onclick="cancelAction()" class="btn-cancel">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, set, remove, onDisconnect, runTransaction, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // --- 1. CONFIG: ‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ---
        const firebaseConfig = {
        apiKey: "AIzaSyCVrVE7okZklN4vmb32RSzsC7JdV7YmcVs",
        authDomain: "oph-booking.firebaseapp.com",
        databaseURL: "https://oph-booking-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "oph-booking",
        storageBucket: "oph-booking.firebasestorage.app",
        messagingSenderId: "222932745199",
        appId: "1:222932745199:web:2f899a96964ab5a5f5141a"
        };
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxdHa_9aRkfX9N5lz_lQr-2xdjm8jyrWY6vmM63ixfw3JSws8w2J8UglEs-bGnuU5wHFw/exec"; 
        // --------------------------------

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const mySessionId = 'user_' + Math.random().toString(36).substr(2, 9);

        // ‡∏î‡∏∂‡∏á ID ‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå‡∏à‡∏≤‡∏Å URL (?id=...)
        const urlParams = new URLSearchParams(window.location.search);
        const eventId = urlParams.get('id');

        let eventData = null;
        let myCurrentSeat = null; // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Cinema

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
        if (!eventId) {
            document.body.innerHTML = "<h1>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå</h1><p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏ú‡πà‡∏≤‡∏ô‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</p>";
        } else {
            loadEventData();
        }

        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå
        function loadEventData() {
            const eventRef = ref(db, 'events/' + eventId);
            
            // ‡πÉ‡∏ä‡πâ get() ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π Config (‡∏ä‡∏∑‡πà‡∏≠, ‡πÅ‡∏ñ‡∏ß, ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå)
            // ‡πÄ‡∏£‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ onValue ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ Config ‡πÑ‡∏°‡πà‡∏Ñ‡∏ß‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ö‡πà‡∏≠‡∏¢ ‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£ render ‡∏ã‡πâ‡∏≥
            get(eventRef).then((snapshot) => {
                if (!snapshot.exists()) {
                    alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå‡∏ô‡∏µ‡πâ");
                    return;
                }
                eventData = snapshot.val();
                renderInterface();
            });
        }

        function renderInterface() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('content').classList.remove('hidden');
            document.getElementById('eventName').innerText = eventData.name;

            if (eventData.type === 'cinema') {
                setupCinema();
            } else {
                setupGeneral();
            }
        }

        // ================= CINEMA LOGIC =================
        function setupCinema() {
            document.getElementById('cinemaZone').classList.remove('hidden');
            document.getElementById('eventTypeDisplay').innerText = "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£";
            
            const rows = eventData.config.rows;
            const cols = eventData.config.cols;
            const mapDiv = document.getElementById('seatMap');
            mapDiv.innerHTML = ''; // Clear old

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á Grid ‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á
            for (let r = 0; r < rows; r++) {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'seat-row';
                const rowLabel = String.fromCharCode(65 + r); // 0->A, 1->B

                for (let c = 1; c <= cols; c++) {
                    const seatId = rowLabel + c;
                    const seatDiv = document.createElement('div');
                    seatDiv.className = 'seat available';
                    seatDiv.innerText = seatId;
                    seatDiv.id = seatId;
                    seatDiv.onclick = () => selectSeatCinema(seatId);
                    rowDiv.appendChild(seatDiv);
                }
                mapDiv.appendChild(rowDiv);
            }

            // Realtime Listener ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå‡∏ô‡∏µ‡πâ
            onValue(ref(db, `events/${eventId}/seats`), (snapshot) => {
                const seatsData = snapshot.val() || {};
                // Loop ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏∏‡∏Å‡∏õ‡∏∏‡πà‡∏°
                document.querySelectorAll('.seat').forEach(el => {
                    const sId = el.id;
                    const sData = seatsData[sId];

                    el.className = 'seat available'; // Reset
                    if (sData) {
                        if (sData.status === 'taken') el.classList.add('taken');
                        else if (sData.status === 'holding') {
                            if (sData.holder === mySessionId) {
                                el.classList.add('holding-me');
                                myCurrentSeat = sId;
                                showForm(sId); // Show form if reloaded/connected
                            } else {
                                el.classList.add('holding-other');
                            }
                        }
                    }
                });
            });
        }

        window.selectSeatCinema = (seatId) => {
            const el = document.getElementById(seatId);
            if (el.classList.contains('taken') || el.classList.contains('holding-other')) return;

            if (seatId === myCurrentSeat) {
                cancelAction(); // ‡∏Å‡∏î‡∏ã‡πâ‡∏≥ = ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                return;
            }

            // ‡∏•‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏Å‡πà‡∏≤‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
            if (myCurrentSeat) remove(ref(db, `events/${eventId}/seats/${myCurrentSeat}`));

            // ‡∏à‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡∏°‡πà
            const seatRef = ref(db, `events/${eventId}/seats/${seatId}`);
            set(seatRef, { status: 'holding', holder: mySessionId, timestamp: Date.now() });
            onDisconnect(seatRef).remove();
        };

        // ================= GENERAL EVENT LOGIC =================
        function setupGeneral() {
            document.getElementById('generalZone').classList.remove('hidden');
            const limit = eventData.limit || 0;
            const limitText = limit === 0 ? "‡πÑ‡∏°‡πà‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô" : `‡∏à‡∏≥‡∏Å‡∏±‡∏î ${limit} ‡πÉ‡∏ö`;
            document.getElementById('limitDisplay').innerText = limitText;

            // Realtime Listener ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô
            onValue(ref(db, `events/${eventId}/bookedCount`), (snapshot) => {
                const count = snapshot.val() || 0;
                document.getElementById('counterDisplay').innerText = count;

                // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏ï‡πá‡∏°‡∏¢‡∏±‡∏á (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ Limit)
                if (limit > 0 && count >= limit) {
                    document.getElementById('generalBookBtn').disabled = true;
                    document.getElementById('generalBookBtn').innerText = "‡∏ö‡∏±‡∏ï‡∏£‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß";
                    document.getElementById('generalBookBtn').style.background = "#ccc";
                    hideForm();
                } else {
                    document.getElementById('generalBookBtn').disabled = false;
                    document.getElementById('generalBookBtn').innerText = "‡∏à‡∏≠‡∏á‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏•‡∏¢";
                    document.getElementById('generalBookBtn').style.background = "#28a745";
                }
            });

            // ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î‡∏à‡∏≠‡∏á (‡πÅ‡∏Ñ‡πà‡πÇ‡∏ä‡∏ß‡πå‡∏ü‡∏≠‡∏£‡πå‡∏° ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏±‡∏î‡∏¢‡∏≠‡∏î)
            document.getElementById('generalBookBtn').onclick = () => {
                showForm("‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏á‡∏≤‡∏ô");
            };
        }

        // ================= SHARED FUNCTIONS =================
        function showForm(itemName) {
            document.getElementById('bookingForm').style.display = 'block';
            document.getElementById('selectedItemName').innerText = itemName;
            // Scroll ‡∏•‡∏á‡∏°‡∏≤‡∏ó‡∏µ‡πà‡∏ü‡∏≠‡∏£‡πå‡∏°
            document.getElementById('bookingForm').scrollIntoView({behavior: 'smooth'});
        }

        function hideForm() {
            document.getElementById('bookingForm').style.display = 'none';
            document.getElementById('userName').value = '';
        }

        window.cancelAction = () => {
            if (eventData.type === 'cinema' && myCurrentSeat) {
                remove(ref(db, `events/${eventId}/seats/${myCurrentSeat}`));
                myCurrentSeat = null;
            }
            hideForm();
        };

        window.confirmBooking = () => {
            const name = document.getElementById('userName').value.trim();
            if (!name) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠");

            if (eventData.type === 'cinema') {
                confirmCinema(name);
            } else {
                confirmGeneral(name);
            }
        };

        // ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô Cinema
        function confirmCinema(name) {
            if (!myCurrentSeat) return;
            const seatId = myCurrentSeat;
            
            // 1. Firebase Update
            set(ref(db, `events/${eventId}/seats/${seatId}`), {
                status: 'taken', owner: name, timestamp: Date.now()
            });

            // 2. Send to Sheets
            sendToSheet(name, seatId);
        }

        // ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô General
        function confirmGeneral(name) {
            const countRef = ref(db, `events/${eventId}/bookedCount`);
            const limit = eventData.limit || 0;

            // Transaction: ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏¢‡πà‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏î‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢
            runTransaction(countRef, (currentCount) => {
                currentCount = currentCount || 0;
                if (limit > 0 && currentCount >= limit) {
                    return; // Abort transaction (‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß)
                }
                return currentCount + 1; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡πà‡∏≤
            }).then((result) => {
                if (result.committed) {
                    // ‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à -> ‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤ Sheet
                    sendToSheet(name, "General Ticket");
                } else {
                    alert("‡πÄ‡∏™‡∏µ‡∏¢‡πÉ‡∏à‡∏î‡πâ‡∏ß‡∏¢ ‡∏ö‡∏±‡∏ï‡∏£‡∏´‡∏°‡∏î‡∏û‡∏≠‡∏î‡∏µ!");
                    hideForm();
                }
            });
        }

        function sendToSheet(name, seatDetail) {
            // ‡∏õ‡∏¥‡∏î UI ‡πÉ‡∏´‡πâ‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î
            document.getElementById('bookingForm').innerHTML = "<p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>";

            fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    name: name, 
                    seat: seatDetail, 
                    eventName: eventData.name // ‡∏™‡πà‡∏á‡∏ä‡∏∑‡πà‡∏≠ Event ‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢
                })
            }).then(() => {
                alert("‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
                location.reload();
            }).catch(err => {
                console.error(err);
                alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡πÅ‡∏ï‡πà‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Sheet ‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤)");
                location.reload();
            });
        }
    </script>
</body>
</html>
